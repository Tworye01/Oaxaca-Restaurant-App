<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: gorm.go in package gorm.io/gorm</title>
<link href="../../../css/dark-v0.6.8.css" rel="stylesheet">
<script src="../../../jvs/golds-v0.6.8.js"></script>
<body onload="onPageLoad()"><div>

<pre id="header"><code><span class="title">Source File</span>
	gorm.go

<span class="title">Belonging Package</span>
	<a href="../../../pkg/gorm.io/gorm.html">gorm.io/gorm</a>
</code></pre>

<pre class="line-numbers">
<span class="codeline" id="line-1"><code>package gorm</code></span>
<span class="codeline" id="line-2"><code></code></span>
<span class="codeline" id="line-3"><code>import (</code></span>
<span class="codeline" id="line-4"><code>	"context"</code></span>
<span class="codeline" id="line-5"><code>	"database/sql"</code></span>
<span class="codeline" id="line-6"><code>	"fmt"</code></span>
<span class="codeline" id="line-7"><code>	"reflect"</code></span>
<span class="codeline" id="line-8"><code>	"sort"</code></span>
<span class="codeline" id="line-9"><code>	"sync"</code></span>
<span class="codeline" id="line-10"><code>	"time"</code></span>
<span class="codeline" id="line-11"><code></code></span>
<span class="codeline" id="line-12"><code>	"gorm.io/gorm/clause"</code></span>
<span class="codeline" id="line-13"><code>	"gorm.io/gorm/logger"</code></span>
<span class="codeline" id="line-14"><code>	"gorm.io/gorm/schema"</code></span>
<span class="codeline" id="line-15"><code>)</code></span>
<span class="codeline" id="line-16"><code></code></span>
<span class="codeline" id="line-17"><code>// for Config.cacheStore store PreparedStmtDB key</code></span>
<span class="codeline" id="line-18"><code>const preparedStmtDBKey = "preparedStmt"</code></span>
<span class="codeline" id="line-19"><code></code></span>
<span class="codeline" id="line-20"><code>// Config GORM config</code></span>
<span class="codeline" id="line-21"><code>type Config struct {</code></span>
<span class="codeline" id="line-22"><code>	// GORM perform single create, update, delete operations in transactions by default to ensure database data integrity</code></span>
<span class="codeline" id="line-23"><code>	// You can disable it by setting `SkipDefaultTransaction` to true</code></span>
<span class="codeline" id="line-24"><code>	SkipDefaultTransaction bool</code></span>
<span class="codeline" id="line-25"><code>	// NamingStrategy tables, columns naming strategy</code></span>
<span class="codeline" id="line-26"><code>	NamingStrategy schema.Namer</code></span>
<span class="codeline" id="line-27"><code>	// FullSaveAssociations full save associations</code></span>
<span class="codeline" id="line-28"><code>	FullSaveAssociations bool</code></span>
<span class="codeline" id="line-29"><code>	// Logger</code></span>
<span class="codeline" id="line-30"><code>	Logger logger.Interface</code></span>
<span class="codeline" id="line-31"><code>	// NowFunc the function to be used when creating a new timestamp</code></span>
<span class="codeline" id="line-32"><code>	NowFunc func() time.Time</code></span>
<span class="codeline" id="line-33"><code>	// DryRun generate sql without execute</code></span>
<span class="codeline" id="line-34"><code>	DryRun bool</code></span>
<span class="codeline" id="line-35"><code>	// PrepareStmt executes the given query in cached statement</code></span>
<span class="codeline" id="line-36"><code>	PrepareStmt bool</code></span>
<span class="codeline" id="line-37"><code>	// DisableAutomaticPing</code></span>
<span class="codeline" id="line-38"><code>	DisableAutomaticPing bool</code></span>
<span class="codeline" id="line-39"><code>	// DisableForeignKeyConstraintWhenMigrating</code></span>
<span class="codeline" id="line-40"><code>	DisableForeignKeyConstraintWhenMigrating bool</code></span>
<span class="codeline" id="line-41"><code>	// IgnoreRelationshipsWhenMigrating</code></span>
<span class="codeline" id="line-42"><code>	IgnoreRelationshipsWhenMigrating bool</code></span>
<span class="codeline" id="line-43"><code>	// DisableNestedTransaction disable nested transaction</code></span>
<span class="codeline" id="line-44"><code>	DisableNestedTransaction bool</code></span>
<span class="codeline" id="line-45"><code>	// AllowGlobalUpdate allow global update</code></span>
<span class="codeline" id="line-46"><code>	AllowGlobalUpdate bool</code></span>
<span class="codeline" id="line-47"><code>	// QueryFields executes the SQL query with all fields of the table</code></span>
<span class="codeline" id="line-48"><code>	QueryFields bool</code></span>
<span class="codeline" id="line-49"><code>	// CreateBatchSize default create batch size</code></span>
<span class="codeline" id="line-50"><code>	CreateBatchSize int</code></span>
<span class="codeline" id="line-51"><code>	// TranslateError enabling error translation</code></span>
<span class="codeline" id="line-52"><code>	TranslateError bool</code></span>
<span class="codeline" id="line-53"><code></code></span>
<span class="codeline" id="line-54"><code>	// ClauseBuilders clause builder</code></span>
<span class="codeline" id="line-55"><code>	ClauseBuilders map[string]clause.ClauseBuilder</code></span>
<span class="codeline" id="line-56"><code>	// ConnPool db conn pool</code></span>
<span class="codeline" id="line-57"><code>	ConnPool ConnPool</code></span>
<span class="codeline" id="line-58"><code>	// Dialector database dialector</code></span>
<span class="codeline" id="line-59"><code>	Dialector</code></span>
<span class="codeline" id="line-60"><code>	// Plugins registered plugins</code></span>
<span class="codeline" id="line-61"><code>	Plugins map[string]Plugin</code></span>
<span class="codeline" id="line-62"><code></code></span>
<span class="codeline" id="line-63"><code>	callbacks  *callbacks</code></span>
<span class="codeline" id="line-64"><code>	cacheStore *sync.Map</code></span>
<span class="codeline" id="line-65"><code>}</code></span>
<span class="codeline" id="line-66"><code></code></span>
<span class="codeline" id="line-67"><code>// Apply update config to new config</code></span>
<span class="codeline" id="line-68"><code>func (c *Config) Apply(config *Config) error {</code></span>
<span class="codeline" id="line-69"><code>	if config != c {</code></span>
<span class="codeline" id="line-70"><code>		*config = *c</code></span>
<span class="codeline" id="line-71"><code>	}</code></span>
<span class="codeline" id="line-72"><code>	return nil</code></span>
<span class="codeline" id="line-73"><code>}</code></span>
<span class="codeline" id="line-74"><code></code></span>
<span class="codeline" id="line-75"><code>// AfterInitialize initialize plugins after db connected</code></span>
<span class="codeline" id="line-76"><code>func (c *Config) AfterInitialize(db *DB) error {</code></span>
<span class="codeline" id="line-77"><code>	if db != nil {</code></span>
<span class="codeline" id="line-78"><code>		for _, plugin := range c.Plugins {</code></span>
<span class="codeline" id="line-79"><code>			if err := plugin.Initialize(db); err != nil {</code></span>
<span class="codeline" id="line-80"><code>				return err</code></span>
<span class="codeline" id="line-81"><code>			}</code></span>
<span class="codeline" id="line-82"><code>		}</code></span>
<span class="codeline" id="line-83"><code>	}</code></span>
<span class="codeline" id="line-84"><code>	return nil</code></span>
<span class="codeline" id="line-85"><code>}</code></span>
<span class="codeline" id="line-86"><code></code></span>
<span class="codeline" id="line-87"><code>// Option gorm option interface</code></span>
<span class="codeline" id="line-88"><code>type Option interface {</code></span>
<span class="codeline" id="line-89"><code>	Apply(*Config) error</code></span>
<span class="codeline" id="line-90"><code>	AfterInitialize(*DB) error</code></span>
<span class="codeline" id="line-91"><code>}</code></span>
<span class="codeline" id="line-92"><code></code></span>
<span class="codeline" id="line-93"><code>// DB GORM DB definition</code></span>
<span class="codeline" id="line-94"><code>type DB struct {</code></span>
<span class="codeline" id="line-95"><code>	*Config</code></span>
<span class="codeline" id="line-96"><code>	Error        error</code></span>
<span class="codeline" id="line-97"><code>	RowsAffected int64</code></span>
<span class="codeline" id="line-98"><code>	Statement    *Statement</code></span>
<span class="codeline" id="line-99"><code>	clone        int</code></span>
<span class="codeline" id="line-100"><code>}</code></span>
<span class="codeline" id="line-101"><code></code></span>
<span class="codeline" id="line-102"><code>// Session session config when create session with Session() method</code></span>
<span class="codeline" id="line-103"><code>type Session struct {</code></span>
<span class="codeline" id="line-104"><code>	DryRun                   bool</code></span>
<span class="codeline" id="line-105"><code>	PrepareStmt              bool</code></span>
<span class="codeline" id="line-106"><code>	NewDB                    bool</code></span>
<span class="codeline" id="line-107"><code>	Initialized              bool</code></span>
<span class="codeline" id="line-108"><code>	SkipHooks                bool</code></span>
<span class="codeline" id="line-109"><code>	SkipDefaultTransaction   bool</code></span>
<span class="codeline" id="line-110"><code>	DisableNestedTransaction bool</code></span>
<span class="codeline" id="line-111"><code>	AllowGlobalUpdate        bool</code></span>
<span class="codeline" id="line-112"><code>	FullSaveAssociations     bool</code></span>
<span class="codeline" id="line-113"><code>	QueryFields              bool</code></span>
<span class="codeline" id="line-114"><code>	Context                  context.Context</code></span>
<span class="codeline" id="line-115"><code>	Logger                   logger.Interface</code></span>
<span class="codeline" id="line-116"><code>	NowFunc                  func() time.Time</code></span>
<span class="codeline" id="line-117"><code>	CreateBatchSize          int</code></span>
<span class="codeline" id="line-118"><code>}</code></span>
<span class="codeline" id="line-119"><code></code></span>
<span class="codeline" id="line-120"><code>// Open initialize db session based on dialector</code></span>
<span class="codeline" id="line-121"><code>func Open(dialector Dialector, opts ...Option) (db *DB, err error) {</code></span>
<span class="codeline" id="line-122"><code>	config := &amp;Config{}</code></span>
<span class="codeline" id="line-123"><code></code></span>
<span class="codeline" id="line-124"><code>	sort.Slice(opts, func(i, j int) bool {</code></span>
<span class="codeline" id="line-125"><code>		_, isConfig := opts[i].(*Config)</code></span>
<span class="codeline" id="line-126"><code>		_, isConfig2 := opts[j].(*Config)</code></span>
<span class="codeline" id="line-127"><code>		return isConfig &amp;&amp; !isConfig2</code></span>
<span class="codeline" id="line-128"><code>	})</code></span>
<span class="codeline" id="line-129"><code></code></span>
<span class="codeline" id="line-130"><code>	for _, opt := range opts {</code></span>
<span class="codeline" id="line-131"><code>		if opt != nil {</code></span>
<span class="codeline" id="line-132"><code>			if applyErr := opt.Apply(config); applyErr != nil {</code></span>
<span class="codeline" id="line-133"><code>				return nil, applyErr</code></span>
<span class="codeline" id="line-134"><code>			}</code></span>
<span class="codeline" id="line-135"><code>			defer func(opt Option) {</code></span>
<span class="codeline" id="line-136"><code>				if errr := opt.AfterInitialize(db); errr != nil {</code></span>
<span class="codeline" id="line-137"><code>					err = errr</code></span>
<span class="codeline" id="line-138"><code>				}</code></span>
<span class="codeline" id="line-139"><code>			}(opt)</code></span>
<span class="codeline" id="line-140"><code>		}</code></span>
<span class="codeline" id="line-141"><code>	}</code></span>
<span class="codeline" id="line-142"><code></code></span>
<span class="codeline" id="line-143"><code>	if d, ok := dialector.(interface{ Apply(*Config) error }); ok {</code></span>
<span class="codeline" id="line-144"><code>		if err = d.Apply(config); err != nil {</code></span>
<span class="codeline" id="line-145"><code>			return</code></span>
<span class="codeline" id="line-146"><code>		}</code></span>
<span class="codeline" id="line-147"><code>	}</code></span>
<span class="codeline" id="line-148"><code></code></span>
<span class="codeline" id="line-149"><code>	if config.NamingStrategy == nil {</code></span>
<span class="codeline" id="line-150"><code>		config.NamingStrategy = schema.NamingStrategy{IdentifierMaxLength: 64} // Default Identifier length is 64</code></span>
<span class="codeline" id="line-151"><code>	}</code></span>
<span class="codeline" id="line-152"><code></code></span>
<span class="codeline" id="line-153"><code>	if config.Logger == nil {</code></span>
<span class="codeline" id="line-154"><code>		config.Logger = logger.Default</code></span>
<span class="codeline" id="line-155"><code>	}</code></span>
<span class="codeline" id="line-156"><code></code></span>
<span class="codeline" id="line-157"><code>	if config.NowFunc == nil {</code></span>
<span class="codeline" id="line-158"><code>		config.NowFunc = func() time.Time { return time.Now().Local() }</code></span>
<span class="codeline" id="line-159"><code>	}</code></span>
<span class="codeline" id="line-160"><code></code></span>
<span class="codeline" id="line-161"><code>	if dialector != nil {</code></span>
<span class="codeline" id="line-162"><code>		config.Dialector = dialector</code></span>
<span class="codeline" id="line-163"><code>	}</code></span>
<span class="codeline" id="line-164"><code></code></span>
<span class="codeline" id="line-165"><code>	if config.Plugins == nil {</code></span>
<span class="codeline" id="line-166"><code>		config.Plugins = map[string]Plugin{}</code></span>
<span class="codeline" id="line-167"><code>	}</code></span>
<span class="codeline" id="line-168"><code></code></span>
<span class="codeline" id="line-169"><code>	if config.cacheStore == nil {</code></span>
<span class="codeline" id="line-170"><code>		config.cacheStore = &amp;sync.Map{}</code></span>
<span class="codeline" id="line-171"><code>	}</code></span>
<span class="codeline" id="line-172"><code></code></span>
<span class="codeline" id="line-173"><code>	db = &amp;DB{Config: config, clone: 1}</code></span>
<span class="codeline" id="line-174"><code></code></span>
<span class="codeline" id="line-175"><code>	db.callbacks = initializeCallbacks(db)</code></span>
<span class="codeline" id="line-176"><code></code></span>
<span class="codeline" id="line-177"><code>	if config.ClauseBuilders == nil {</code></span>
<span class="codeline" id="line-178"><code>		config.ClauseBuilders = map[string]clause.ClauseBuilder{}</code></span>
<span class="codeline" id="line-179"><code>	}</code></span>
<span class="codeline" id="line-180"><code></code></span>
<span class="codeline" id="line-181"><code>	if config.Dialector != nil {</code></span>
<span class="codeline" id="line-182"><code>		err = config.Dialector.Initialize(db)</code></span>
<span class="codeline" id="line-183"><code></code></span>
<span class="codeline" id="line-184"><code>		if err != nil {</code></span>
<span class="codeline" id="line-185"><code>			if db, _ := db.DB(); db != nil {</code></span>
<span class="codeline" id="line-186"><code>				_ = db.Close()</code></span>
<span class="codeline" id="line-187"><code>			}</code></span>
<span class="codeline" id="line-188"><code>		}</code></span>
<span class="codeline" id="line-189"><code>	}</code></span>
<span class="codeline" id="line-190"><code></code></span>
<span class="codeline" id="line-191"><code>	if config.PrepareStmt {</code></span>
<span class="codeline" id="line-192"><code>		preparedStmt := NewPreparedStmtDB(db.ConnPool)</code></span>
<span class="codeline" id="line-193"><code>		db.cacheStore.Store(preparedStmtDBKey, preparedStmt)</code></span>
<span class="codeline" id="line-194"><code>		db.ConnPool = preparedStmt</code></span>
<span class="codeline" id="line-195"><code>	}</code></span>
<span class="codeline" id="line-196"><code></code></span>
<span class="codeline" id="line-197"><code>	db.Statement = &amp;Statement{</code></span>
<span class="codeline" id="line-198"><code>		DB:       db,</code></span>
<span class="codeline" id="line-199"><code>		ConnPool: db.ConnPool,</code></span>
<span class="codeline" id="line-200"><code>		Context:  context.Background(),</code></span>
<span class="codeline" id="line-201"><code>		Clauses:  map[string]clause.Clause{},</code></span>
<span class="codeline" id="line-202"><code>	}</code></span>
<span class="codeline" id="line-203"><code></code></span>
<span class="codeline" id="line-204"><code>	if err == nil &amp;&amp; !config.DisableAutomaticPing {</code></span>
<span class="codeline" id="line-205"><code>		if pinger, ok := db.ConnPool.(interface{ Ping() error }); ok {</code></span>
<span class="codeline" id="line-206"><code>			err = pinger.Ping()</code></span>
<span class="codeline" id="line-207"><code>		}</code></span>
<span class="codeline" id="line-208"><code>	}</code></span>
<span class="codeline" id="line-209"><code></code></span>
<span class="codeline" id="line-210"><code>	if err != nil {</code></span>
<span class="codeline" id="line-211"><code>		config.Logger.Error(context.Background(), "failed to initialize database, got error %v", err)</code></span>
<span class="codeline" id="line-212"><code>	}</code></span>
<span class="codeline" id="line-213"><code></code></span>
<span class="codeline" id="line-214"><code>	return</code></span>
<span class="codeline" id="line-215"><code>}</code></span>
<span class="codeline" id="line-216"><code></code></span>
<span class="codeline" id="line-217"><code>// Session create new db session</code></span>
<span class="codeline" id="line-218"><code>func (db *DB) Session(config *Session) *DB {</code></span>
<span class="codeline" id="line-219"><code>	var (</code></span>
<span class="codeline" id="line-220"><code>		txConfig = *db.Config</code></span>
<span class="codeline" id="line-221"><code>		tx       = &amp;DB{</code></span>
<span class="codeline" id="line-222"><code>			Config:    &amp;txConfig,</code></span>
<span class="codeline" id="line-223"><code>			Statement: db.Statement,</code></span>
<span class="codeline" id="line-224"><code>			Error:     db.Error,</code></span>
<span class="codeline" id="line-225"><code>			clone:     1,</code></span>
<span class="codeline" id="line-226"><code>		}</code></span>
<span class="codeline" id="line-227"><code>	)</code></span>
<span class="codeline" id="line-228"><code>	if config.CreateBatchSize &gt; 0 {</code></span>
<span class="codeline" id="line-229"><code>		tx.Config.CreateBatchSize = config.CreateBatchSize</code></span>
<span class="codeline" id="line-230"><code>	}</code></span>
<span class="codeline" id="line-231"><code></code></span>
<span class="codeline" id="line-232"><code>	if config.SkipDefaultTransaction {</code></span>
<span class="codeline" id="line-233"><code>		tx.Config.SkipDefaultTransaction = true</code></span>
<span class="codeline" id="line-234"><code>	}</code></span>
<span class="codeline" id="line-235"><code></code></span>
<span class="codeline" id="line-236"><code>	if config.AllowGlobalUpdate {</code></span>
<span class="codeline" id="line-237"><code>		txConfig.AllowGlobalUpdate = true</code></span>
<span class="codeline" id="line-238"><code>	}</code></span>
<span class="codeline" id="line-239"><code></code></span>
<span class="codeline" id="line-240"><code>	if config.FullSaveAssociations {</code></span>
<span class="codeline" id="line-241"><code>		txConfig.FullSaveAssociations = true</code></span>
<span class="codeline" id="line-242"><code>	}</code></span>
<span class="codeline" id="line-243"><code></code></span>
<span class="codeline" id="line-244"><code>	if config.Context != nil || config.PrepareStmt || config.SkipHooks {</code></span>
<span class="codeline" id="line-245"><code>		tx.Statement = tx.Statement.clone()</code></span>
<span class="codeline" id="line-246"><code>		tx.Statement.DB = tx</code></span>
<span class="codeline" id="line-247"><code>	}</code></span>
<span class="codeline" id="line-248"><code></code></span>
<span class="codeline" id="line-249"><code>	if config.Context != nil {</code></span>
<span class="codeline" id="line-250"><code>		tx.Statement.Context = config.Context</code></span>
<span class="codeline" id="line-251"><code>	}</code></span>
<span class="codeline" id="line-252"><code></code></span>
<span class="codeline" id="line-253"><code>	if config.PrepareStmt {</code></span>
<span class="codeline" id="line-254"><code>		var preparedStmt *PreparedStmtDB</code></span>
<span class="codeline" id="line-255"><code></code></span>
<span class="codeline" id="line-256"><code>		if v, ok := db.cacheStore.Load(preparedStmtDBKey); ok {</code></span>
<span class="codeline" id="line-257"><code>			preparedStmt = v.(*PreparedStmtDB)</code></span>
<span class="codeline" id="line-258"><code>		} else {</code></span>
<span class="codeline" id="line-259"><code>			preparedStmt = NewPreparedStmtDB(db.ConnPool)</code></span>
<span class="codeline" id="line-260"><code>			db.cacheStore.Store(preparedStmtDBKey, preparedStmt)</code></span>
<span class="codeline" id="line-261"><code>		}</code></span>
<span class="codeline" id="line-262"><code></code></span>
<span class="codeline" id="line-263"><code>		switch t := tx.Statement.ConnPool.(type) {</code></span>
<span class="codeline" id="line-264"><code>		case Tx:</code></span>
<span class="codeline" id="line-265"><code>			tx.Statement.ConnPool = &amp;PreparedStmtTX{</code></span>
<span class="codeline" id="line-266"><code>				Tx:             t,</code></span>
<span class="codeline" id="line-267"><code>				PreparedStmtDB: preparedStmt,</code></span>
<span class="codeline" id="line-268"><code>			}</code></span>
<span class="codeline" id="line-269"><code>		default:</code></span>
<span class="codeline" id="line-270"><code>			tx.Statement.ConnPool = &amp;PreparedStmtDB{</code></span>
<span class="codeline" id="line-271"><code>				ConnPool: db.Config.ConnPool,</code></span>
<span class="codeline" id="line-272"><code>				Mux:      preparedStmt.Mux,</code></span>
<span class="codeline" id="line-273"><code>				Stmts:    preparedStmt.Stmts,</code></span>
<span class="codeline" id="line-274"><code>			}</code></span>
<span class="codeline" id="line-275"><code>		}</code></span>
<span class="codeline" id="line-276"><code>		txConfig.ConnPool = tx.Statement.ConnPool</code></span>
<span class="codeline" id="line-277"><code>		txConfig.PrepareStmt = true</code></span>
<span class="codeline" id="line-278"><code>	}</code></span>
<span class="codeline" id="line-279"><code></code></span>
<span class="codeline" id="line-280"><code>	if config.SkipHooks {</code></span>
<span class="codeline" id="line-281"><code>		tx.Statement.SkipHooks = true</code></span>
<span class="codeline" id="line-282"><code>	}</code></span>
<span class="codeline" id="line-283"><code></code></span>
<span class="codeline" id="line-284"><code>	if config.DisableNestedTransaction {</code></span>
<span class="codeline" id="line-285"><code>		txConfig.DisableNestedTransaction = true</code></span>
<span class="codeline" id="line-286"><code>	}</code></span>
<span class="codeline" id="line-287"><code></code></span>
<span class="codeline" id="line-288"><code>	if !config.NewDB {</code></span>
<span class="codeline" id="line-289"><code>		tx.clone = 2</code></span>
<span class="codeline" id="line-290"><code>	}</code></span>
<span class="codeline" id="line-291"><code></code></span>
<span class="codeline" id="line-292"><code>	if config.DryRun {</code></span>
<span class="codeline" id="line-293"><code>		tx.Config.DryRun = true</code></span>
<span class="codeline" id="line-294"><code>	}</code></span>
<span class="codeline" id="line-295"><code></code></span>
<span class="codeline" id="line-296"><code>	if config.QueryFields {</code></span>
<span class="codeline" id="line-297"><code>		tx.Config.QueryFields = true</code></span>
<span class="codeline" id="line-298"><code>	}</code></span>
<span class="codeline" id="line-299"><code></code></span>
<span class="codeline" id="line-300"><code>	if config.Logger != nil {</code></span>
<span class="codeline" id="line-301"><code>		tx.Config.Logger = config.Logger</code></span>
<span class="codeline" id="line-302"><code>	}</code></span>
<span class="codeline" id="line-303"><code></code></span>
<span class="codeline" id="line-304"><code>	if config.NowFunc != nil {</code></span>
<span class="codeline" id="line-305"><code>		tx.Config.NowFunc = config.NowFunc</code></span>
<span class="codeline" id="line-306"><code>	}</code></span>
<span class="codeline" id="line-307"><code></code></span>
<span class="codeline" id="line-308"><code>	if config.Initialized {</code></span>
<span class="codeline" id="line-309"><code>		tx = tx.getInstance()</code></span>
<span class="codeline" id="line-310"><code>	}</code></span>
<span class="codeline" id="line-311"><code></code></span>
<span class="codeline" id="line-312"><code>	return tx</code></span>
<span class="codeline" id="line-313"><code>}</code></span>
<span class="codeline" id="line-314"><code></code></span>
<span class="codeline" id="line-315"><code>// WithContext change current instance db's context to ctx</code></span>
<span class="codeline" id="line-316"><code>func (db *DB) WithContext(ctx context.Context) *DB {</code></span>
<span class="codeline" id="line-317"><code>	return db.Session(&amp;Session{Context: ctx})</code></span>
<span class="codeline" id="line-318"><code>}</code></span>
<span class="codeline" id="line-319"><code></code></span>
<span class="codeline" id="line-320"><code>// Debug start debug mode</code></span>
<span class="codeline" id="line-321"><code>func (db *DB) Debug() (tx *DB) {</code></span>
<span class="codeline" id="line-322"><code>	tx = db.getInstance()</code></span>
<span class="codeline" id="line-323"><code>	return tx.Session(&amp;Session{</code></span>
<span class="codeline" id="line-324"><code>		Logger: db.Logger.LogMode(logger.Info),</code></span>
<span class="codeline" id="line-325"><code>	})</code></span>
<span class="codeline" id="line-326"><code>}</code></span>
<span class="codeline" id="line-327"><code></code></span>
<span class="codeline" id="line-328"><code>// Set store value with key into current db instance's context</code></span>
<span class="codeline" id="line-329"><code>func (db *DB) Set(key string, value interface{}) *DB {</code></span>
<span class="codeline" id="line-330"><code>	tx := db.getInstance()</code></span>
<span class="codeline" id="line-331"><code>	tx.Statement.Settings.Store(key, value)</code></span>
<span class="codeline" id="line-332"><code>	return tx</code></span>
<span class="codeline" id="line-333"><code>}</code></span>
<span class="codeline" id="line-334"><code></code></span>
<span class="codeline" id="line-335"><code>// Get get value with key from current db instance's context</code></span>
<span class="codeline" id="line-336"><code>func (db *DB) Get(key string) (interface{}, bool) {</code></span>
<span class="codeline" id="line-337"><code>	return db.Statement.Settings.Load(key)</code></span>
<span class="codeline" id="line-338"><code>}</code></span>
<span class="codeline" id="line-339"><code></code></span>
<span class="codeline" id="line-340"><code>// InstanceSet store value with key into current db instance's context</code></span>
<span class="codeline" id="line-341"><code>func (db *DB) InstanceSet(key string, value interface{}) *DB {</code></span>
<span class="codeline" id="line-342"><code>	tx := db.getInstance()</code></span>
<span class="codeline" id="line-343"><code>	tx.Statement.Settings.Store(fmt.Sprintf("%p", tx.Statement)+key, value)</code></span>
<span class="codeline" id="line-344"><code>	return tx</code></span>
<span class="codeline" id="line-345"><code>}</code></span>
<span class="codeline" id="line-346"><code></code></span>
<span class="codeline" id="line-347"><code>// InstanceGet get value with key from current db instance's context</code></span>
<span class="codeline" id="line-348"><code>func (db *DB) InstanceGet(key string) (interface{}, bool) {</code></span>
<span class="codeline" id="line-349"><code>	return db.Statement.Settings.Load(fmt.Sprintf("%p", db.Statement) + key)</code></span>
<span class="codeline" id="line-350"><code>}</code></span>
<span class="codeline" id="line-351"><code></code></span>
<span class="codeline" id="line-352"><code>// Callback returns callback manager</code></span>
<span class="codeline" id="line-353"><code>func (db *DB) Callback() *callbacks {</code></span>
<span class="codeline" id="line-354"><code>	return db.callbacks</code></span>
<span class="codeline" id="line-355"><code>}</code></span>
<span class="codeline" id="line-356"><code></code></span>
<span class="codeline" id="line-357"><code>// AddError add error to db</code></span>
<span class="codeline" id="line-358"><code>func (db *DB) AddError(err error) error {</code></span>
<span class="codeline" id="line-359"><code>	if err != nil {</code></span>
<span class="codeline" id="line-360"><code>		if db.Config.TranslateError {</code></span>
<span class="codeline" id="line-361"><code>			if errTranslator, ok := db.Dialector.(ErrorTranslator); ok {</code></span>
<span class="codeline" id="line-362"><code>				err = errTranslator.Translate(err)</code></span>
<span class="codeline" id="line-363"><code>			}</code></span>
<span class="codeline" id="line-364"><code>		}</code></span>
<span class="codeline" id="line-365"><code></code></span>
<span class="codeline" id="line-366"><code>		if db.Error == nil {</code></span>
<span class="codeline" id="line-367"><code>			db.Error = err</code></span>
<span class="codeline" id="line-368"><code>		} else {</code></span>
<span class="codeline" id="line-369"><code>			db.Error = fmt.Errorf("%v; %w", db.Error, err)</code></span>
<span class="codeline" id="line-370"><code>		}</code></span>
<span class="codeline" id="line-371"><code>	}</code></span>
<span class="codeline" id="line-372"><code>	return db.Error</code></span>
<span class="codeline" id="line-373"><code>}</code></span>
<span class="codeline" id="line-374"><code></code></span>
<span class="codeline" id="line-375"><code>// DB returns `*sql.DB`</code></span>
<span class="codeline" id="line-376"><code>func (db *DB) DB() (*sql.DB, error) {</code></span>
<span class="codeline" id="line-377"><code>	connPool := db.ConnPool</code></span>
<span class="codeline" id="line-378"><code>	if db.Statement != nil &amp;&amp; db.Statement.ConnPool != nil {</code></span>
<span class="codeline" id="line-379"><code>		connPool = db.Statement.ConnPool</code></span>
<span class="codeline" id="line-380"><code>	}</code></span>
<span class="codeline" id="line-381"><code>	if tx, ok := connPool.(*sql.Tx); ok &amp;&amp; tx != nil {</code></span>
<span class="codeline" id="line-382"><code>		return (*sql.DB)(reflect.ValueOf(tx).Elem().FieldByName("db").UnsafePointer()), nil</code></span>
<span class="codeline" id="line-383"><code>	}</code></span>
<span class="codeline" id="line-384"><code></code></span>
<span class="codeline" id="line-385"><code>	if dbConnector, ok := connPool.(GetDBConnector); ok &amp;&amp; dbConnector != nil {</code></span>
<span class="codeline" id="line-386"><code>		if sqldb, err := dbConnector.GetDBConn(); sqldb != nil || err != nil {</code></span>
<span class="codeline" id="line-387"><code>			return sqldb, err</code></span>
<span class="codeline" id="line-388"><code>		}</code></span>
<span class="codeline" id="line-389"><code>	}</code></span>
<span class="codeline" id="line-390"><code></code></span>
<span class="codeline" id="line-391"><code>	if sqldb, ok := connPool.(*sql.DB); ok &amp;&amp; sqldb != nil {</code></span>
<span class="codeline" id="line-392"><code>		return sqldb, nil</code></span>
<span class="codeline" id="line-393"><code>	}</code></span>
<span class="codeline" id="line-394"><code></code></span>
<span class="codeline" id="line-395"><code>	return nil, ErrInvalidDB</code></span>
<span class="codeline" id="line-396"><code>}</code></span>
<span class="codeline" id="line-397"><code></code></span>
<span class="codeline" id="line-398"><code>func (db *DB) getInstance() *DB {</code></span>
<span class="codeline" id="line-399"><code>	if db.clone &gt; 0 {</code></span>
<span class="codeline" id="line-400"><code>		tx := &amp;DB{Config: db.Config, Error: db.Error}</code></span>
<span class="codeline" id="line-401"><code></code></span>
<span class="codeline" id="line-402"><code>		if db.clone == 1 {</code></span>
<span class="codeline" id="line-403"><code>			// clone with new statement</code></span>
<span class="codeline" id="line-404"><code>			tx.Statement = &amp;Statement{</code></span>
<span class="codeline" id="line-405"><code>				DB:        tx,</code></span>
<span class="codeline" id="line-406"><code>				ConnPool:  db.Statement.ConnPool,</code></span>
<span class="codeline" id="line-407"><code>				Context:   db.Statement.Context,</code></span>
<span class="codeline" id="line-408"><code>				Clauses:   map[string]clause.Clause{},</code></span>
<span class="codeline" id="line-409"><code>				Vars:      make([]interface{}, 0, 8),</code></span>
<span class="codeline" id="line-410"><code>				SkipHooks: db.Statement.SkipHooks,</code></span>
<span class="codeline" id="line-411"><code>			}</code></span>
<span class="codeline" id="line-412"><code>		} else {</code></span>
<span class="codeline" id="line-413"><code>			// with clone statement</code></span>
<span class="codeline" id="line-414"><code>			tx.Statement = db.Statement.clone()</code></span>
<span class="codeline" id="line-415"><code>			tx.Statement.DB = tx</code></span>
<span class="codeline" id="line-416"><code>		}</code></span>
<span class="codeline" id="line-417"><code></code></span>
<span class="codeline" id="line-418"><code>		return tx</code></span>
<span class="codeline" id="line-419"><code>	}</code></span>
<span class="codeline" id="line-420"><code></code></span>
<span class="codeline" id="line-421"><code>	return db</code></span>
<span class="codeline" id="line-422"><code>}</code></span>
<span class="codeline" id="line-423"><code></code></span>
<span class="codeline" id="line-424"><code>// Expr returns clause.Expr, which can be used to pass SQL expression as params</code></span>
<span class="codeline" id="line-425"><code>func Expr(expr string, args ...interface{}) clause.Expr {</code></span>
<span class="codeline" id="line-426"><code>	return clause.Expr{SQL: expr, Vars: args}</code></span>
<span class="codeline" id="line-427"><code>}</code></span>
<span class="codeline" id="line-428"><code></code></span>
<span class="codeline" id="line-429"><code>// SetupJoinTable setup join table schema</code></span>
<span class="codeline" id="line-430"><code>func (db *DB) SetupJoinTable(model interface{}, field string, joinTable interface{}) error {</code></span>
<span class="codeline" id="line-431"><code>	var (</code></span>
<span class="codeline" id="line-432"><code>		tx                      = db.getInstance()</code></span>
<span class="codeline" id="line-433"><code>		stmt                    = tx.Statement</code></span>
<span class="codeline" id="line-434"><code>		modelSchema, joinSchema *schema.Schema</code></span>
<span class="codeline" id="line-435"><code>	)</code></span>
<span class="codeline" id="line-436"><code></code></span>
<span class="codeline" id="line-437"><code>	err := stmt.Parse(model)</code></span>
<span class="codeline" id="line-438"><code>	if err != nil {</code></span>
<span class="codeline" id="line-439"><code>		return err</code></span>
<span class="codeline" id="line-440"><code>	}</code></span>
<span class="codeline" id="line-441"><code>	modelSchema = stmt.Schema</code></span>
<span class="codeline" id="line-442"><code></code></span>
<span class="codeline" id="line-443"><code>	err = stmt.Parse(joinTable)</code></span>
<span class="codeline" id="line-444"><code>	if err != nil {</code></span>
<span class="codeline" id="line-445"><code>		return err</code></span>
<span class="codeline" id="line-446"><code>	}</code></span>
<span class="codeline" id="line-447"><code>	joinSchema = stmt.Schema</code></span>
<span class="codeline" id="line-448"><code></code></span>
<span class="codeline" id="line-449"><code>	relation, ok := modelSchema.Relationships.Relations[field]</code></span>
<span class="codeline" id="line-450"><code>	isRelation := ok &amp;&amp; relation.JoinTable != nil</code></span>
<span class="codeline" id="line-451"><code>	if !isRelation {</code></span>
<span class="codeline" id="line-452"><code>		return fmt.Errorf("failed to find relation: %s", field)</code></span>
<span class="codeline" id="line-453"><code>	}</code></span>
<span class="codeline" id="line-454"><code></code></span>
<span class="codeline" id="line-455"><code>	for _, ref := range relation.References {</code></span>
<span class="codeline" id="line-456"><code>		f := joinSchema.LookUpField(ref.ForeignKey.DBName)</code></span>
<span class="codeline" id="line-457"><code>		if f == nil {</code></span>
<span class="codeline" id="line-458"><code>			return fmt.Errorf("missing field %s for join table", ref.ForeignKey.DBName)</code></span>
<span class="codeline" id="line-459"><code>		}</code></span>
<span class="codeline" id="line-460"><code></code></span>
<span class="codeline" id="line-461"><code>		f.DataType = ref.ForeignKey.DataType</code></span>
<span class="codeline" id="line-462"><code>		f.GORMDataType = ref.ForeignKey.GORMDataType</code></span>
<span class="codeline" id="line-463"><code>		if f.Size == 0 {</code></span>
<span class="codeline" id="line-464"><code>			f.Size = ref.ForeignKey.Size</code></span>
<span class="codeline" id="line-465"><code>		}</code></span>
<span class="codeline" id="line-466"><code>		ref.ForeignKey = f</code></span>
<span class="codeline" id="line-467"><code>	}</code></span>
<span class="codeline" id="line-468"><code></code></span>
<span class="codeline" id="line-469"><code>	for name, rel := range relation.JoinTable.Relationships.Relations {</code></span>
<span class="codeline" id="line-470"><code>		if _, ok := joinSchema.Relationships.Relations[name]; !ok {</code></span>
<span class="codeline" id="line-471"><code>			rel.Schema = joinSchema</code></span>
<span class="codeline" id="line-472"><code>			joinSchema.Relationships.Relations[name] = rel</code></span>
<span class="codeline" id="line-473"><code>		}</code></span>
<span class="codeline" id="line-474"><code>	}</code></span>
<span class="codeline" id="line-475"><code>	relation.JoinTable = joinSchema</code></span>
<span class="codeline" id="line-476"><code></code></span>
<span class="codeline" id="line-477"><code>	return nil</code></span>
<span class="codeline" id="line-478"><code>}</code></span>
<span class="codeline" id="line-479"><code></code></span>
<span class="codeline" id="line-480"><code>// Use use plugin</code></span>
<span class="codeline" id="line-481"><code>func (db *DB) Use(plugin Plugin) error {</code></span>
<span class="codeline" id="line-482"><code>	name := plugin.Name()</code></span>
<span class="codeline" id="line-483"><code>	if _, ok := db.Plugins[name]; ok {</code></span>
<span class="codeline" id="line-484"><code>		return ErrRegistered</code></span>
<span class="codeline" id="line-485"><code>	}</code></span>
<span class="codeline" id="line-486"><code>	if err := plugin.Initialize(db); err != nil {</code></span>
<span class="codeline" id="line-487"><code>		return err</code></span>
<span class="codeline" id="line-488"><code>	}</code></span>
<span class="codeline" id="line-489"><code>	db.Plugins[name] = plugin</code></span>
<span class="codeline" id="line-490"><code>	return nil</code></span>
<span class="codeline" id="line-491"><code>}</code></span>
<span class="codeline" id="line-492"><code></code></span>
<span class="codeline" id="line-493"><code>// ToSQL for generate SQL string.</code></span>
<span class="codeline" id="line-494"><code>//</code></span>
<span class="codeline" id="line-495"><code>//	db.ToSQL(func(tx *gorm.DB) *gorm.DB {</code></span>
<span class="codeline" id="line-496"><code>//			return tx.Model(&amp;User{}).Where(&amp;User{Name: "foo", Age: 20})</code></span>
<span class="codeline" id="line-497"><code>//				.Limit(10).Offset(5)</code></span>
<span class="codeline" id="line-498"><code>//				.Order("name ASC")</code></span>
<span class="codeline" id="line-499"><code>//				.First(&amp;User{})</code></span>
<span class="codeline" id="line-500"><code>//	})</code></span>
<span class="codeline" id="line-501"><code>func (db *DB) ToSQL(queryFn func(tx *DB) *DB) string {</code></span>
<span class="codeline" id="line-502"><code>	tx := queryFn(db.Session(&amp;Session{DryRun: true, SkipDefaultTransaction: true}))</code></span>
<span class="codeline" id="line-503"><code>	stmt := tx.Statement</code></span>
<span class="codeline" id="line-504"><code></code></span>
<span class="codeline" id="line-505"><code>	return db.Dialector.Explain(stmt.SQL.String(), stmt.Vars...)</code></span>
<span class="codeline" id="line-506"><code>}</code></span>
</pre><pre id="footer">
<table><tr><td><img src="../../../png/go101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/apps-and-libs/golds.html"><b>Golds</b></a> <i>v0.6.8</i>. (GOOS=linux GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/go100and1">@Go100and1</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table></pre>